package com.purcotton.scm.base.rds.service;

import com.google.common.collect.Lists;
import com.purcotton.scm.base.common.exception.BusinessException;
import com.purcotton.scm.base.rds.pojo.TableFieldEntity;
import com.purcotton.scm.base.rds.pojo.TableInfoEntity;
import lombok.extern.slf4j.Slf4j;

import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Collections;
import java.util.List;

@Slf4j
public class LocalTableFieldService {
    protected DataSource dataSource;
    //所有本地表信息 本项目的所有表
    protected static List<TableInfoEntity> localTableList;

    public LocalTableFieldService(DataSource dataSource) {
        this.dataSource = dataSource;
        localTableList=parseLocalTableInfo();
    }

    private List<TableInfoEntity> parseLocalTableInfo() {
        try (Connection connection=dataSource.getConnection()) {
            try (PreparedStatement preparedTableStatement = connection.prepareStatement("show table status");
                 ResultSet resultTableSet = preparedTableStatement.executeQuery()){
                List<TableInfoEntity> tableInfoList = Lists.newArrayList();
                while (resultTableSet.next()){
                    TableInfoEntity tableInfoEntity = new TableInfoEntity()
                            .setName(resultTableSet.getString("name"))
                            .setComment(resultTableSet.getString("comment"));
                    try (PreparedStatement preparedFieldStatement = connection.prepareStatement("show full fields from "+tableInfoEntity.getName());
                         ResultSet resultFieldSet = preparedFieldStatement.executeQuery()){
                        List<TableFieldEntity> tableFieldList = Lists.newArrayList();
                        while (resultFieldSet.next()){
                            TableFieldEntity tableFieldEntity = new TableFieldEntity()
                                    .setField(resultFieldSet.getString("field"))
                                    .setType(resultFieldSet.getString("type"))
                                    .setCollation(resultFieldSet.getString("collation"))
                                    .setNullable(resultFieldSet.getString("null"))
                                    .setKey(resultFieldSet.getString("key"))
                                    .setDefaultValue(resultFieldSet.getString("default"))
                                    .setExtra(resultFieldSet.getString("extra"))
                                    .setComment(resultFieldSet.getString("comment"));
                            tableFieldList.add(tableFieldEntity);
                        }
                        tableInfoEntity.setFieldList(tableFieldList);
                    }
                    tableInfoList.add(tableInfoEntity);
                }
                return tableInfoList;
            }
        } catch (SQLException e) {
            log.error("变式获取表sql异常",e);
            throw new RuntimeException("变式获取表sql异常",e);
        }
    }
    /**
     * 所有本地的表信息 与webKey无关
     * @return
     */
    public List<TableInfoEntity> getLocalTableInfo(){
        if(localTableList==null){
            throw new RuntimeException("表配置没有准备好请使用TableFieldService bean来获取！");
        }
        return Collections.unmodifiableList(localTableList);
    }

}
